<audio preload="auto" loop id="musicAudio" src="/audio/background/<%= bgm %>.ogg" class="hidden"></audio>
<audio preload="none" id="soundAudio" class="hidden"></audio>

<script>
    const musicPlayer = document.getElementById("musicAudio");
    const soundPlayer = document.getElementById("soundAudio");
    const audiosCache = {};
    const vibrationPattern = [6, 3, 6];
    const randomSound = () => Math.floor(Math.random() * (2 - 1) + 1);
    const locks = {
        audio: false,
        sound: false
    };

    const vibrate = (pattern) => {
        const savedSettings = JSON.parse(localStorage.getItem("cucuRiduSettings")) || {};
        const permissions = { vibration: true, ...savedSettings };
        if(permissions["vibration"])
            navigator.vibrate(pattern);
    };
    const playAudio = async (elementToPlay, checkValue = "sound", reverse = false) => {
        if(reverse) return await elementToPlay.pause();
        const savedSettings = JSON.parse(localStorage.getItem("cucuRiduSettings")) || {};
        const permissions = { audio: true, sound: true, ...savedSettings };
        if (checkValue === "audio" && locks[checkValue]) return;
        locks[checkValue] = true;
        try {
            switch (checkValue) {
                case "sound": {
                    const sound = randomSound();
                    if(permissions[checkValue]) {
                        if(!audiosCache[sound]) {
                            const result = await fetch("/audio/sound/" + sound + ".mp3");
                            if(!result.ok) throw new Error("audio not found");
                            audiosCache[sound] = URL.createObjectURL(await result.blob());
                        }
                        if(elementToPlay.src !== audiosCache[sound])
                            elementToPlay.src = audiosCache[sound];
                        await elementToPlay.play();
                        elementToPlay.onpause = () =>  locks[checkValue] = false;
                    } else locks[checkValue] = false;
                    break;
                }
                case "audio": {
                    if(permissions[checkValue]) await elementToPlay.play();
                    else await elementToPlay.pause();
                    locks[checkValue] = false;
                }
            }
        } catch {
            locks[checkValue] = false;
        }
    };

    (() => {
        const initMusic = async () => {
            try { await playAudio(musicPlayer, "audio") } catch {}
        };

        document.addEventListener("DOMContentLoaded", () => {
            [...document.querySelectorAll("button"),
                ...[...document.querySelectorAll("body *")].filter(element =>
                    [element.classList].filter(classe => classe.toString().toLowerCase().includes("btn")).length > 0 || element.id.toLowerCase().includes("btn"))
            ].forEach(button => {
                button.addEventListener("click", () => {
                    vibrate(vibrationPattern);
                    playAudio(soundPlayer);
                });
            });
        });

        document.addEventListener("click", initMusic, { once: true });

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) playAudio(musicPlayer, "audio", true);
            else playAudio(musicPlayer, "audio");
        });

        window.addEventListener("pageshow", (event) => {
            if (event.persisted) {
                initMusic();
                document.addEventListener("click", initMusic, { once: true });
            }
        });
    })();
</script>